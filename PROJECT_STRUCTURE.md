# Project Structure

Complete overview of the Peripage Printer API project structure and file purposes.

```
demo-peri-page-v6/
â”‚
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ main.go                         # Application entry point
â”‚                                           # - Dependency injection
â”‚                                           # - Server initialization
â”‚                                           # - Swagger annotations for API info
â”‚
â”œâ”€â”€ internal/                               # Private application code
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                               # Core domain layer (business logic)
â”‚   â”‚   â”œâ”€â”€ ports.go                        # Printer interface definition
â”‚   â”‚   â”‚                                   # - Defines Printer port
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ service.go                      # Print service implementation
â”‚   â”‚   â”‚                                   # - PrintText() for plain text
â”‚   â”‚   â”‚                                   # - PrintJSON() for formatted JSON
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ service_test.go                 # Unit tests for service
â”‚   â”‚                                       # - Tests business logic
â”‚   â”‚
â”‚   â”œâ”€â”€ adapters/                           # External adapters
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/                            # HTTP API adapter (Gin)
â”‚   â”‚   â”‚   â”œâ”€â”€ handler.go                  # HTTP request handlers
â”‚   â”‚   â”‚   â”‚                               # - Print() endpoint
â”‚   â”‚   â”‚   â”‚                               # - HealthCheck() endpoint
â”‚   â”‚   â”‚   â”‚                               # - Swagger annotations
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ router.go                   # Route configuration
â”‚   â”‚   â”‚                                   # - Router setup
â”‚   â”‚   â”‚                                   # - Middleware registration
â”‚   â”‚   â”‚                                   # - Swagger UI endpoint
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ printer/                        # Printer adapters
â”‚   â”‚   â”‚   â”œâ”€â”€ mock.go                     # Mock printer implementation
â”‚   â”‚   â”‚   â”‚                               # - Prints to stdout
â”‚   â”‚   â”‚   â”‚                               # - For development/testing
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ ble.go                      # BLE printer implementation
â”‚   â”‚   â”‚                                   # - Bluetooth LE communication
â”‚   â”‚   â”‚                                   # - Device discovery & connection
â”‚   â”‚   â”‚                                   # - Handshake protocol (TODO)
â”‚   â”‚   â”‚                                   # - Text-to-bitmap (TODO)
â”‚   â”‚   â”‚                                   # - Packet transmission (TODO)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ docs/                           # Swagger documentation
â”‚   â”‚       â”œâ”€â”€ docs.go                     # Generated by swag
â”‚   â”‚       â”œâ”€â”€ swagger.json                # Generated by swag
â”‚   â”‚       â””â”€â”€ swagger.yaml                # Generated by swag
â”‚   â”‚
â”‚   â””â”€â”€ config/                             # Configuration management
â”‚       â””â”€â”€ config.go                       # Environment variable loader
â”‚                                           # - Server config
â”‚                                           # - Printer config
â”‚                                           # - BLE config
â”‚
â”œâ”€â”€ Dockerfile                              # Docker image definition
â”‚                                           # - Multi-stage build
â”‚                                           # - Bluetooth dependencies
â”‚
â”œâ”€â”€ docker-compose.yml                      # Production deployment
â”‚                                           # - Host networking
â”‚                                           # - Privileged mode for BLE
â”‚                                           # - Device mounts
â”‚
â”œâ”€â”€ docker-compose.dev.yml                  # Development deployment
â”‚                                           # - Mock printer
â”‚                                           # - Port mapping
â”‚                                           # - No hardware requirements
â”‚
â”œâ”€â”€ Makefile                                # Build automation
â”‚                                           # - Common commands
â”‚                                           # - Build, test, run
â”‚                                           # - Docker operations
â”‚
â”œâ”€â”€ start.sh                                # Interactive start script
â”‚                                           # - Dependency check
â”‚                                           # - Swagger generation
â”‚                                           # - Run mode selection
â”‚
â”œâ”€â”€ go.mod                                  # Go module definition
â”œâ”€â”€ go.sum                                  # Dependency checksums
â”‚
â”œâ”€â”€ .env.example                            # Example environment config
â”œâ”€â”€ .gitignore                              # Git ignore rules
â”‚
â”œâ”€â”€ README.md                               # Main documentation
â”œâ”€â”€ API_TESTING.md                          # API testing guide
â””â”€â”€ BLE_IMPLEMENTATION_TODO.md              # BLE implementation guide
```

## Layer Descriptions

### ğŸ¯ Core Layer (`internal/core/`)

**Purpose:** Contains pure business logic, independent of external concerns.

- **No external dependencies** (except standard library)
- **Defines ports** (interfaces) that adapters must implement
- **Contains domain logic** for print operations
- **Testable** without external services

**Key Principle:** The core never imports from adapters. Adapters depend on core, not vice versa.

---

### ğŸ”Œ Adapters Layer (`internal/adapters/`)

**Purpose:** Implements external integrations and ports defined by core.

#### API Adapter (`internal/adapters/api/`)

- Translates HTTP requests to domain operations
- Uses Gin framework for routing
- Handles HTTP concerns (status codes, JSON)
- Depends on core domain

#### Printer Adapters (`internal/adapters/printer/`)

- **Mock:** Development/testing implementation
- **BLE:** Production Bluetooth implementation
- Both implement `core.Printer` interface
- Interchangeable via dependency injection

---

### âš™ï¸ Configuration (`internal/config/`)

**Purpose:** Centralized configuration management.

- Loads from environment variables
- Validates configuration
- Provides type-safe access
- Single source of truth

---

### ğŸš€ Entry Point (`cmd/server/`)

**Purpose:** Application bootstrap and wiring.

- Loads configuration
- Selects appropriate printer adapter
- Initializes core service
- Starts HTTP server
- Handles graceful shutdown

**Dependency Flow:**

```
main.go
  â†“
config â†’ PrinterAdapter â†’ PrintService â†’ APIHandler â†’ Router â†’ Server
```

---

## File Relationships

### Dependency Graph

```
                    main.go
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“              â†“              â†“
    config.go    printer/*.go    api/*.go
        â†“              â†“              â†“
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
                  core/ports.go
                       â†“
                  core/service.go
```

### Data Flow

```
HTTP Request
     â†“
API Handler (handler.go)
     â†“
Print Service (service.go)
     â†“
Printer Interface (ports.go)
     â†“
Printer Adapter (mock.go or ble.go)
     â†“
Output (stdout or BLE device)
```

---

## Key Design Patterns

### 1. Hexagonal Architecture (Ports & Adapters)

- Core domain at center
- Adapters on outside
- Communication through interfaces

### 2. Dependency Injection

- Dependencies passed via constructors
- Easy testing with mocks
- Flexible adapter swapping

### 3. Repository Pattern

- Printer interface acts as repository
- Multiple implementations
- Core doesn't know about concrete types

### 4. Service Layer

- Business logic in service
- Thin handlers in API layer
- Clear separation of concerns

---

## Testing Strategy

### Unit Tests

- **Location:** `*_test.go` files next to source
- **Focus:** Core business logic
- **Mocking:** Use mock printer for testing service

### Integration Tests

- **Location:** Top-level `tests/` (can be added)
- **Focus:** API endpoints with mock printer
- **Tools:** HTTP test client

### Hardware Tests

- **Location:** Manual testing
- **Focus:** BLE adapter with real device
- **Process:** Follow BLE_IMPLEMENTATION_TODO.md

---

## Configuration Flow

```
.env file
    â†“
Environment Variables
    â†“
config.Load()
    â†“
Config struct
    â†“
main.go (dependency injection)
    â†“
Application components
```

---

## Build & Deploy Flow

### Development

```
go run cmd/server/main.go
```

### Production (Binary)

```
go build -o bin/peripage-server ./cmd/server
./bin/peripage-server
```

### Docker

```
docker-compose build
    â†“
Multi-stage Dockerfile
    â†“
- Build stage: compile Go binary
- Runtime stage: minimal Alpine image
    â†“
docker-compose up
```

---

## Extension Points

### Adding New Printer Adapter

1. Create `internal/adapters/printer/new_adapter.go`
2. Implement `core.Printer` interface
3. Add config option in `internal/config/config.go`
4. Wire in `cmd/server/main.go`

### Adding New API Endpoint

1. Add handler method in `internal/adapters/api/handler.go`
2. Add Swagger annotations
3. Register route in `internal/adapters/api/router.go`
4. Update service if needed in `internal/core/service.go`

### Adding New Business Logic

1. Add method to `internal/core/service.go`
2. Write tests in `internal/core/service_test.go`
3. Expose via API if needed

---

## Documentation Files

| File                         | Purpose                             |
| ---------------------------- | ----------------------------------- |
| `README.md`                  | Main documentation, getting started |
| `API_TESTING.md`             | API endpoint examples and testing   |
| `BLE_IMPLEMENTATION_TODO.md` | Detailed BLE implementation guide   |
| `PROJECT_STRUCTURE.md`       | This file - architecture overview   |

---

## Quick Reference

### Run Commands

```bash
make run              # Development (mock)
make run-ble          # Production (BLE)
make docker-up-dev    # Docker (mock)
make docker-up        # Docker (BLE)
./start.sh            # Interactive
```

### Development Commands

```bash
make deps             # Install dependencies
make swagger          # Generate docs
make test             # Run tests
make build            # Build binary
```

---

This structure follows **SOLID principles** and makes the codebase:

- âœ… Easy to test
- âœ… Easy to extend
- âœ… Easy to maintain
- âœ… Technology-agnostic
- âœ… Production-ready
